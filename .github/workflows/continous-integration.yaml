name: Continuous Integration

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  Invoke-Terraform-CI:
    uses: cloudutsukpilot/github-workflows/.github/workflows/terraform-CI.yaml@main
    secrets: inherit
    with:
      providers: azurerm
  
  # Non-Prod
  Invoke-Terraform-CD:
    name: non-production
    needs: Invoke-Terraform-CI
    uses: cloudutsukpilot/github-workflows/.github/workflows/terraform-CD.yaml@main
    with:
      working_environment: cloudutsuk
      working_directory:
      providers: azurerm
    secrets:
      arm_tenant_id: ${{ secrets.ARM_TENANT_ID }}
      arm_subscription_id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      arm_client_id: ${{ vars.ARM_CLIENT_ID }}
      arm_client_secret: ${{ secrets.ARM_CLIENT_SECRET }}
      repo_read_token: ${{ secrets.GIT_REPO_READ_TOKEN }}